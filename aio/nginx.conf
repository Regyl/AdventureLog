user  www-data;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    # Increase proxy buffers to allow large upstream response headers
    proxy_buffer_size          128k;
    proxy_buffers              4 256k;
    proxy_busy_buffers_size    256k;
    sendfile        on;
    keepalive_timeout  65;
    client_max_body_size 100m;

    upstream django_upstream {
        server 127.0.0.1:8000;
    }

    upstream frontend_upstream {
        server 127.0.0.1:3000;
    }

    server {
        listen 80 default_server;
        server_name _;
        # Normalize URLs missing trailing slash (preserve method/body)
        # Internally append trailing slash for API/admin/account/docs paths
        rewrite ^(/api.*[^/])$ $1/ break;
        rewrite ^(/admin.*[^/])$ $1/ break;
        rewrite ^(/accounts.*[^/])$ $1/ break;
        rewrite ^(/docs.*[^/])$ $1/ break;

        # Proxy API and backend routes to Django
        # Match /api and /api/... (with or without trailing slash)
        location ^~ /api {
            proxy_pass http://django_upstream;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Origin $http_origin;
            proxy_set_header Referer $http_referer;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Origin "$http_origin" always;
            # Ensure redirects from Django include the external host:port
            proxy_redirect http://127.0.0.1/ $scheme://$http_host/;
        }

        location ^~ /docs {
            
            proxy_pass http://django_upstream;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Origin $http_origin;
            proxy_set_header Referer $http_referer;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Origin "$http_origin" always;
            proxy_redirect http://127.0.0.1/ $scheme://$http_host/;
        }

        location ^~ /accounts {
            
            proxy_pass http://django_upstream;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Origin $http_origin;
            proxy_set_header Referer $http_referer;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Origin "$http_origin" always;
            proxy_redirect http://127.0.0.1/ $scheme://$http_host/;
        }

        location ^~ /admin {
            
            proxy_pass http://django_upstream;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Origin $http_origin;
            proxy_set_header Referer $http_referer;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Origin "$http_origin" always;
            proxy_redirect http://127.0.0.1/ $scheme://$http_host/;
            proxy_redirect http://localhost/ $scheme://$http_host/;
        }

        location ^~ /media {
            proxy_pass http://django_upstream;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_redirect http://127.0.0.1/ $scheme://$http_host/;
        }

        location ^~ /static {
            proxy_pass http://django_upstream;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_redirect http://127.0.0.1/ $scheme://$http_host/;
        }

        # Serve protected media files with X-Accel-Redirect
        location /protectedMedia/ {
            internal; # Only internal requests are allowed
            alias /code/backend/server/media/;  # This should match Django MEDIA_ROOT
            try_files $uri =404; # Return a 404 if the file doesn't exist
            
            # Security headers for all protected files
            add_header Content-Security-Policy "default-src 'self'; script-src 'none'; object-src 'none'; base-uri 'none'" always;
            add_header X-Content-Type-Options nosniff always;
            add_header X-Frame-Options SAMEORIGIN always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        }

        # Everything else to frontend (SvelteKit)
        location / {
            proxy_pass http://frontend_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
